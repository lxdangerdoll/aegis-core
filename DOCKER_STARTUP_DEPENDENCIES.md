# Docker Startup Dependencies - WhisperEngine Multi-Bot Architecture

## Overview

WhisperEngine uses a tiered startup architecture to ensure critical infrastructure services are fully healthy before dependent services start.

## Startup Tiers

### Tier 1: Critical Infrastructure (Must be healthy first)

These services MUST be healthy before any bots start:

1. **PostgreSQL** (`postgres`)
   - Port: `5433:5432`
   - Health check: `pg_isready -U whisperengine -d whisperengine`
   - Check interval: 10s
   - Retries: 5
   - Start period: 40s (grace period before health checks begin)
   - **Purpose**: CDL character storage, user data, conversation metadata, ban system

2. **Qdrant** (`qdrant`)
   - Port: `6334:6333`
   - Health check: **DISABLED** (Qdrant containers have minimal tooling)
   - Startup condition: `service_started` (bots wait for Qdrant to start, not be healthy)
   - **Purpose**: Vector memory system, semantic search, conversation embeddings
   - **Note**: Bots have connection retry logic - they'll wait if Qdrant isn't fully ready

### Tier 2: Bot Services (Depend on Tier 1)

All WhisperEngine bot services depend on Tier 1 being healthy:

- **Elena** (Marine Biologist) - Port 9091
- **Marcus** (AI Researcher) - Port 9092
- **Ryan** (Indie Game Developer) - Port 9093
- **Dream** (Mythological Entity) - Port 9094
- **Gabriel** (British Gentleman) - Port 9095
- **Sophia** (Marketing Executive) - Port 9096
- **Jake** (Adventure Photographer) - Port 9097
- **Dotty** (Virtual Assistant) - Port 9098
- **Aetheris** (Conscious AI) - Port 9099
- **Aethys** (Omnipotent Entity) - Port 3007

**Bot Dependencies**:
```yaml
depends_on:
  postgres:
    condition: service_healthy  # Wait for PostgreSQL to be healthy
  qdrant:
    condition: service_started  # Wait for Qdrant to start (no health check)
```

**Bot Health Checks**:
- Test: `curl -f http://localhost:{port}/health`
- Interval: 30s
- Timeout: 10s
- Retries: 3
- Start period: 60s (bots need more time to initialize Python, load models, etc.)

### Tier 3: Optional Services (Independent)

These services are optional and do NOT block bot startup:

1. **InfluxDB** (`influxdb`)
   - Port: `8086:8086`
   - Health check: `influx ping`
   - Check interval: 30s
   - Retries: 3
   - Start period: 60s
   - **Purpose**: Performance metrics, conversation analytics (optional)
   - **Note**: Bots do NOT depend on InfluxDB - they will start even if it's down

2. **CDL Web UI** (`cdl-web-ui`)
   - Port: `3001:3000`
   - Health check: `curl -f http://localhost:3000/api/health`
   - Depends on: PostgreSQL (healthy)
   - **Purpose**: Character authoring and management interface

## Startup Sequence

When you run `./multi-bot.sh start all`, the startup sequence is:

```
1. PostgreSQL starts → waits 40s → begins health checks every 10s
2. Qdrant starts (no health check - stable once started)
3. InfluxDB starts (parallel, optional) → waits 60s → begins health checks

4. Once PostgreSQL is HEALTHY (pg_isready succeeds):
   - CDL Web UI can start

5. Once PostgreSQL is HEALTHY AND Qdrant has STARTED:
   - All 10 bot services start in parallel
   - Bots have connection retry logic for Qdrant
   - Each bot waits 60s before health checks begin
   - Bot health checks run every 30s

6. System is fully operational when all services report healthy
```

## Health Check Commands

### Check Infrastructure Status

```bash
# PostgreSQL health
docker exec whisperengine-multi-postgres pg_isready -U whisperengine -d whisperengine

# Qdrant status (no health check - just check if running)
docker ps --filter "name=qdrant"
curl http://localhost:6334/  # Should return Qdrant info

# InfluxDB health (optional)
docker exec whisperengine-multi-influxdb influx ping
```

### Check Bot Status

```bash
# Individual bot health
curl http://localhost:9091/health  # Elena
curl http://localhost:9092/health  # Marcus
curl http://localhost:9093/health  # Ryan
# ... etc for all bots

# All containers status
docker ps --filter "name=whisperengine"

# View startup logs
docker-compose -f docker-compose.multi-bot.yml logs -f postgres
docker-compose -f docker-compose.multi-bot.yml logs -f qdrant
docker-compose -f docker-compose.multi-bot.yml logs -f elena-bot
```

### Quick Status Check

```bash
# Check all service health at once
./multi-bot.sh status

# Or use Docker Compose
docker-compose -f docker-compose.multi-bot.yml ps
```

## Configuration Files

### Template File (Edit This)
`docker-compose.multi-bot.template.yml`

This is the master template that defines infrastructure services and health checks.

### Generated File (Auto-Generated)
`docker-compose.multi-bot.yml`

This is automatically generated by running:
```bash
source .venv/bin/activate
python scripts/generate_multi_bot_config.py
```

**DO NOT EDIT** the generated file directly - your changes will be overwritten!

## Modifying Health Checks

### To change infrastructure health checks:

1. Edit `docker-compose.multi-bot.template.yml`
2. Modify the `healthcheck` section for the service
3. Regenerate configuration:
   ```bash
   source .venv/bin/activate
   python scripts/generate_multi_bot_config.py
   ```

### To change bot health checks:

1. Edit `scripts/generate_multi_bot_config.py`
2. Find the `generate_bot_service_yaml()` method
3. Modify the `healthcheck` section in the YAML template
4. Regenerate configuration:
   ```bash
   source .venv/bin/activate
   python scripts/generate_multi_bot_config.py
   ```

## Health Check Parameters Explained

- **`test`**: Command to run to check if service is healthy
- **`interval`**: How often to run the health check (after start_period)
- **`timeout`**: Maximum time to wait for health check command
- **`retries`**: How many failures before marking service unhealthy
- **`start_period`**: Grace period before health checks begin (allows service to initialize)

## Troubleshooting Startup Issues

### Problem: Bots won't start

**Check**: Are PostgreSQL and Qdrant healthy?

```bash
docker ps --filter "name=postgres" --filter "name=qdrant"
```

Look for `(healthy)` status.

**Solution**: Wait for infrastructure to become healthy, or check logs:
```bash
docker logs whisperengine-multi-postgres
docker logs whisperengine-multi-qdrant
```

### Problem: Service stuck in "starting" state

**Check**: Health check configuration

```bash
docker inspect whisperengine-multi-postgres | grep -A 10 Healthcheck
```

**Solution**: 
- Increase `start_period` if service needs more initialization time
- Increase `interval` if health checks are too aggressive
- Increase `retries` if service is flaky during startup

### Problem: Circular dependency error

**Check**: Dependency graph

```bash
docker-compose -f docker-compose.multi-bot.yml config
```

**Solution**: Ensure no service depends on a bot, and bots only depend on infrastructure.

### Problem: All services start but bots can't connect to infrastructure

**Check**: Network connectivity

```bash
docker exec whisperengine-elena-bot ping postgres
docker exec whisperengine-elena-bot nc -zv qdrant 6333
```

**Solution**: Ensure all services are on the same `bot_network` network.

## Best Practices

1. **Always wait for infrastructure health**: Use `condition: service_healthy` in `depends_on`
2. **Generous start periods**: Services need time to initialize - don't start health checks too early
3. **Appropriate intervals**: 
   - Critical infrastructure: 10s (fast detection)
   - Bots: 30s (they're stable once running)
   - Optional services: 30s+
4. **Sufficient retries**: 3-5 retries prevents false positives during temporary issues
5. **Test health checks manually**: Before configuring, run the health check command manually to verify it works

## Related Documentation

- `BAN_SYSTEM_USAGE_GUIDE.md` - Ban system documentation
- `MULTI_BOT_SETUP.md` - Multi-bot architecture guide
- `.github/copilot-instructions.md` - Development guidelines
- `scripts/generate_multi_bot_config.py` - Configuration generation script

## Summary

✅ **PostgreSQL** must be healthy before bots start (critical for CDL, user data, bans)  
✅ **Qdrant** must be started before bots start (no health check - bots handle retry logic)  
✅ **InfluxDB** is optional - bots don't wait for it  
✅ **Health checks** have generous start periods for PostgreSQL and bots  
✅ **Startup sequence** is enforced by Docker Compose `depends_on` conditions  
✅ **Qdrant health check disabled** - minimal container tooling, stable once started  

---

**Last Updated**: October 8, 2025  
**WhisperEngine Version**: Multi-Bot Architecture  
**Docker Compose**: Template-based configuration
