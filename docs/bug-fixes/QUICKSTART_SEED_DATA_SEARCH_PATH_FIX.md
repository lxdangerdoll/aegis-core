# Quickstart Seed Data - Search Path Fix

**Date**: October 12, 2025  
**Issue**: Seed data INSERT statements failing with "column normalized_name does not exist"  
**Status**: ✅ FIXED

## Problem Description

During quickstart installation flow, the seed data insertion for the default "AI Assistant" character was failing with an error indicating that the `normalized_name` column doesn't exist, even though the column is correctly defined in the schema.

## Root Cause Analysis

### The Issue: Empty search_path

1. **Schema is Correct**: The `00_init.sql` file correctly creates the `characters` table with the `normalized_name` column:
   ```sql
   CREATE TABLE public.characters (
       id integer NOT NULL,
       name character varying(500) NOT NULL,
       normalized_name character varying(200) NOT NULL,  -- ✅ Column exists!
       ...
   );
   ```

2. **pg_dump Default Behavior**: The `00_init.sql` file (generated by `pg_dump`) includes:
   ```sql
   SELECT pg_catalog.set_config('search_path', '', false);
   ```
   This sets the PostgreSQL search_path to an **empty string**, meaning subsequent SQL statements won't find tables without schema qualification.

3. **Seed Data Uses Unqualified Names**: The `01_seed_data.sql` file uses unqualified table names:
   ```sql
   INSERT INTO characters (...)  -- Missing schema qualification!
   ```

4. **Migration Script Fix Only Applied to 00_init.sql**: The `run_migrations.py` script has code to fix the search_path issue:
   ```python
   if "pg_catalog.set_config('search_path', '', false)" in sql:
       sql = sql.replace("pg_catalog.set_config('search_path', '', false)", 
                        "pg_catalog.set_config('search_path', 'public', false)")
   ```
   However, this only fixes the `00_init.sql` file. When `01_seed_data.sql` runs separately, it doesn't have a search_path set and inherits the empty search_path from the session.

## The Fix

Added explicit `SET search_path = public;` at the beginning of `01_seed_data.sql`:

```sql
-- ============================================================================
-- WhisperEngine Seed Data
-- ============================================================================

-- Set search_path to public schema to ensure tables are found
-- This is critical because 00_init.sql sets search_path to empty string
SET search_path = public;

-- ============================================================================
-- Default AI Assistant Character for Quickstart
-- ============================================================================

INSERT INTO characters (
    name, 
    normalized_name,
    ...
```

## Why This Fix Works

1. **Explicit Schema Context**: By setting `search_path = public;` at the start of the seed data file, all subsequent unqualified table references (like `INSERT INTO characters`) will correctly resolve to `public.characters`.

2. **Idempotent**: The `ON CONFLICT (normalized_name) DO NOTHING` clause ensures the seed data can be run multiple times safely.

3. **Maintains Simplicity**: We keep the clean, unqualified table names in the INSERT statements rather than needing to change them all to `public.characters`.

4. **Compatible with Migration Script**: This works alongside the existing `run_migrations.py` fix for `00_init.sql`.

## Verification

The `normalized_name` column **does exist** in the schema:
- ✅ Defined in `00_init.sql` line 2350
- ✅ Has UNIQUE constraint (line 4562)
- ✅ Has index `idx_characters_normalized_name`
- ✅ Used correctly in seed data INSERT statement

The issue was **not** a missing column, but rather a PostgreSQL search_path configuration issue that prevented the seed data from finding the correctly-defined table.

## Files Modified

- ✅ `sql/01_seed_data.sql` - Added `SET search_path = public;`

## Testing

To test this fix:

```bash
# Start fresh PostgreSQL
docker-compose -f docker-compose.quickstart.yml up -d postgres

# Run migrations (should now succeed)
docker-compose -f docker-compose.quickstart.yml up db-migrate

# Verify seed data inserted
docker exec whisperengine-postgres psql -U whisperengine -d whisperengine \
  -c "SELECT name, normalized_name, occupation FROM characters WHERE normalized_name = 'assistant';"
```

Expected output:
```
     name      | normalized_name |  occupation  
---------------+-----------------+--------------
 AI Assistant  | assistant       | AI Assistant
```

## Related Documentation

- PostgreSQL search_path: https://www.postgresql.org/docs/current/ddl-schemas.html#DDL-SCHEMAS-PATH
- pg_dump behavior: https://www.postgresql.org/docs/current/app-pgdump.html
- WhisperEngine quickstart setup: `quickstart-setup.sh`
